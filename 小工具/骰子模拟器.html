<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éª°å­æ¨¡æ‹Ÿå™¨</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            color: white;
            padding: 15px;
            padding-bottom: env(safe-area-inset-bottom, 15px);
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: clamp(20px, 5vw, 30px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: clamp(25px, 5vw, 40px);
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(79, 195, 247, 0.3);
        }
        
        h1 {
            font-size: clamp(2.2rem, 7vw, 3rem);
            margin-bottom: 10px;
            background: linear-gradient(to right, #ff8a00, #da1b60);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            line-height: 1.2;
        }
        
        .subtitle {
            font-size: clamp(1rem, 3.5vw, 1.2rem);
            opacity: 0.8;
            margin-bottom: 20px;
        }
        
        .back-btn {
            display: inline-block;
            background: rgba(79, 195, 247, 0.2);
            color: #4fc3f7;
            padding: 10px 20px;
            border-radius: 50px;
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            margin-top: 10px;
            border: 1px solid rgba(79, 195, 247, 0.3);
        }
        
        .back-btn:hover {
            background: rgba(79, 195, 247, 0.4);
            transform: translateY(-2px);
        }
        
        .app-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
        }
        
        @media (min-width: 992px) {
            .app-container {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            background: rgba(30, 30, 50, 0.8);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        
        .section-title {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: #4fc3f7;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(79, 195, 247, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            font-size: 1.2rem;
        }
        
        /* éª°å­ç»„æ ·å¼ */
        .dice-groups {
            margin-bottom: 25px;
        }
        
        .dice-group {
            background: rgba(40, 40, 60, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .dice-group:hover {
            border-color: rgba(79, 195, 247, 0.5);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .group-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }
        
        .group-number {
            width: 32px;
            height: 32px;
            background: linear-gradient(45deg, #4fc3f7, #29b6f6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .group-name input {
            flex: 1;
            background: rgba(20, 20, 40, 0.8);
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 8px;
            padding: 10px 15px;
            color: white;
            font-size: 1rem;
            min-width: 200px;
        }
        
        .group-name input:focus {
            outline: none;
            border-color: #4fc3f7;
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
        }
        
        .dice-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-size: 0.9rem;
            color: #e0e0e0;
        }
        
        input, select {
            background: rgba(20, 20, 40, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
            color: white;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #4fc3f7;
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
        }
        
        .modifier-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .modifier-input select {
            width: 60px;
            text-align: center;
        }
        
        .modifier-input input {
            flex: 1;
        }
        
        .group-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .remove-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .remove-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .add-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
        }
        
        .warning-btn {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .warning-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(243, 156, 18, 0.4);
        }
        
        /* å…¨å±€è°ƒæ•´å€¼æ ·å¼ */
        .global-modifiers {
            margin-bottom: 25px;
        }
        
        .global-modifier {
            background: rgba(40, 40, 60, 0.6);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 15px;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .global-modifier {
                grid-template-columns: 1fr;
            }
        }
        
        /* æœŸæœ›å€¼æ˜¾ç¤º */
        .expectation-display {
            background: linear-gradient(45deg, rgba(39, 174, 96, 0.2), rgba(46, 204, 113, 0.2));
            border: 1px solid rgba(39, 174, 96, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        
        .expectation-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 5px;
        }
        
        .expectation-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* ç»“æœæ˜¾ç¤º */
        .result-display {
            background: linear-gradient(45deg, rgba(79, 195, 247, 0.2), rgba(41, 182, 246, 0.2));
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 12px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }
        
        .result-total {
            font-size: 4rem;
            font-weight: bold;
            color: #4fc3f7;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .result-expression {
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
            font-family: 'Monaco', 'Consolas', monospace;
            word-break: break-word;
        }
        
        /* æŠ•æ·æŒ‰é’® */
        .roll-btn {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .roll-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(155, 89, 182, 0.4);
        }
        
        .clear-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 16px 24px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .clear-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(231, 76, 60, 0.4);
        }
        
        /* å†å²è®°å½•é¢æ¿ */
        .history-panel {
            background: rgba(30, 30, 50, 0.8);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }
        
        /* ç»Ÿè®¡ç½‘æ ¼ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            background: rgba(40, 40, 60, 0.6);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4fc3f7;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        /* å†å²è®°å½•åˆ—è¡¨ */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            padding-right: 5px;
        }
        
        .history-item {
            background: rgba(40, 40, 60, 0.6);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        
        .history-item:hover {
            border-color: rgba(79, 195, 247, 0.5);
            transform: translateX(5px);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .history-title {
            font-weight: bold;
            color: #e0e0e0;
            font-size: 0.95rem;
        }
        
        .history-time {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }
        
        .history-result {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4fc3f7;
            margin-bottom: 8px;
        }
        
        .history-expression {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 12px;
            font-family: 'Monaco', 'Consolas', monospace;
            word-break: break-word;
        }
        
        .history-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .history-actions input {
            flex: 1;
            background: rgba(20, 20, 40, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 8px 12px;
            color: white;
            font-size: 0.9rem;
        }
        
        .history-actions button {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .reroll-btn {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
        }
        
        .delete-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
        }
        
        .history-actions button:hover {
            transform: translateY(-2px);
        }
        
        /* å†å²è®°å½•æ“ä½œæŒ‰é’® */
        .history-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .export-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.4);
        }
        
        .clear-history-btn {
            background: linear-gradient(45deg, #e74c3c, #c0392b);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .clear-history-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(231, 76, 60, 0.4);
        }
        
        /* è‡ªå®šä¹‰é¢æ•°è¾“å…¥æ¡† */
        .custom-sides-input {
            display: none;
            margin-top: 10px;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: rgba(255, 255, 255, 0.5);
            font-style: italic;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
                border-radius: 12px;
            }
            
            .control-panel, .history-panel {
                padding: 20px;
            }
            
            .dice-config {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .history-buttons {
                grid-template-columns: 1fr;
            }
            
            .result-total {
                font-size: 3rem;
            }
        }
        
        /* é˜²æ­¢IOSç¼©æ”¾ */
        @supports (-webkit-overflow-scrolling: touch) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
        
        /* å®‰å…¨åŒºåŸŸé€‚é… */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(15px, env(safe-area-inset-left, 15px));
                padding-right: max(15px, env(safe-area-inset-right, 15px));
                padding-bottom: max(15px, env(safe-area-inset-bottom, 15px));
            }
        }
        
        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: rgba(20, 20, 40, 0.6);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: rgba(79, 195, 247, 0.5);
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: rgba(79, 195, 247, 0.8);
        }
        
        /* éšè—å…ƒç´  */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-dice"></i> éª°å­æ¨¡æ‹Ÿå™¨</h1>
            <p class="subtitle">TRPGè·‘å›¢éª°å­å·¥å…· - æ”¯æŒéª°å­ç»„å‘½åã€å…¨å±€è°ƒæ•´å€¼ã€æœŸæœ›å€¼è®¡ç®—</p>
            <a href="../index.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> è¿”å›é¦–é¡µ
            </a>
        </header>
        
        <div class="app-container">
            <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
            <div class="control-panel">
                <!-- éª°å­ç»„è®¾ç½® -->
                <div class="dice-groups">
                    <div class="section-title">
                        <i class="fas fa-cube"></i> éª°å­ç»„è®¾ç½®
                    </div>
                    
                    <div id="diceGroups">
                        <!-- éª°å­ç»„å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                        <div class="empty-state">
                            <i class="fas fa-dice"></i>
                            <p>æš‚æ— éª°å­ç»„ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </p>
                        </div>
                    </div>
                    
                    <button onclick="addDiceGroup()" class="add-btn">
                        <i class="fas fa-plus"></i> æ·»åŠ éª°å­ç»„
                    </button>
                </div>
                
                <!-- å…¨å±€è°ƒæ•´å€¼ -->
                <div class="global-modifiers">
                    <div class="section-title">
                        <i class="fas fa-sliders-h"></i> å…¨å±€è°ƒæ•´å€¼
                    </div>
                    
                    <div id="globalModifiers">
                        <!-- å…¨å±€è°ƒæ•´å€¼å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                        <div class="empty-state">
                            <i class="fas fa-plus-circle"></i>
                            <p>æš‚æ— å…¨å±€è°ƒæ•´å€¼</p>
                        </div>
                    </div>
                    
                    <button onclick="addGlobalModifier()" class="warning-btn">
                        <i class="fas fa-plus"></i> æ·»åŠ å…¨å±€è°ƒæ•´å€¼
                    </button>
                </div>
                
                <!-- æœŸæœ›å€¼æ˜¾ç¤º -->
                <div class="expectation-display" id="expectationDisplay">
                    <div class="expectation-value">0</div>
                    <div class="expectation-label">æœŸæœ›å€¼</div>
                </div>
                
                <!-- ç»“æœæ˜¾ç¤º -->
                <div class="result-display" id="resultDisplay">
                    <div class="result-total">0</div>
                    <div class="result-expression">ç‚¹å‡»æŠ•æ·æŸ¥çœ‹ç»“æœ</div>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <button onclick="rollDice()" class="roll-btn">
                    <i class="fas fa-dice"></i> æŠ•æ·éª°å­
                </button>
                
                <button onclick="clearAllDice()" class="clear-btn">
                    <i class="fas fa-trash"></i> æ¸…ç©ºæ‰€æœ‰è®¾ç½®
                </button>
            </div>
            
            <!-- å³ä¾§å†å²è®°å½•é¢æ¿ -->
            <div class="history-panel">
                <div class="section-title">
                    <i class="fas fa-history"></i> æŠ•æ·å†å²ä¸ç»Ÿè®¡
                </div>
                
                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalRolls">0</div>
                        <div class="stat-label">æ€»æŠ•æ·æ¬¡æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="averageResult">0</div>
                        <div class="stat-label">å¹³å‡ç»“æœ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="maxResult">0</div>
                        <div class="stat-label">æœ€å¤§ç»“æœ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="minResult">0</div>
                        <div class="stat-label">æœ€å°ç»“æœ</div>
                    </div>
                </div>
                
                <!-- å†å²è®°å½•åˆ—è¡¨ -->
                <div class="history-list" id="historyList">
                    <!-- å†å²è®°å½•å°†åŠ¨æ€æ·»åŠ åˆ°è¿™é‡Œ -->
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>æš‚æ— æŠ•æ·è®°å½•</p>
                    </div>
                </div>
                
                <!-- å†å²è®°å½•æ“ä½œæŒ‰é’® -->
                <div class="history-buttons">
                    <button onclick="exportHistory()" class="export-btn">
                        <i class="fas fa-download"></i> å¯¼å‡ºå†å²è®°å½•
                    </button>
                    <button onclick="clearHistory()" class="clear-history-btn">
                        <i class="fas fa-trash"></i> æ¸…ç©ºå†å²è®°å½•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åº”ç”¨çŠ¶æ€
        let diceGroups = [];
        let globalModifiers = [];
        let rollHistory = [];
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadHistory();
            renderDiceGroups();
            renderGlobalModifiers();
            updateExpectation();
        });
        
        // æ·»åŠ éª°å­ç»„
        function addDiceGroup() {
            diceGroups.push({
                id: Date.now(),
                name: `éª°å­ç»„ ${diceGroups.length + 1}`,
                count: 1,
                sides: 6,
                isCustomSides: false,
                customSides: 6,
                modifier: 0,
                modifierType: '+'
            });
            renderDiceGroups();
            updateExpectation();
        }
        
        // ç§»é™¤éª°å­ç»„
        function removeDiceGroup(id) {
            diceGroups = diceGroups.filter(group => group.id !== id);
            renderDiceGroups();
            updateExpectation();
        }
        
        // æ¸²æŸ“éª°å­ç»„
        function renderDiceGroups() {
            const container = document.getElementById('diceGroups');
            container.innerHTML = '';
            
            if (diceGroups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-dice"></i>
                        <p>æš‚æ— éª°å­ç»„ï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ </p>
                    </div>
                `;
                return;
            }
            
            diceGroups.forEach((group, index) => {
                const groupElement = document.createElement('div');
                groupElement.className = 'dice-group';
                groupElement.innerHTML = `
                    <div class="group-header">
                        <div class="group-number">${index + 1}</div>
                        <div class="group-name">
                            <input type="text" value="${group.name}" placeholder="éª°å­ç»„åç§°" 
                                   onchange="updateDiceGroup(${group.id}, 'name', this.value)">
                        </div>
                    </div>
                    <div class="dice-config">
                        <div class="form-group">
                            <label><i class="fas fa-dice"></i> éª°å­æ•°é‡</label>
                            <input type="number" value="${group.count}" min="1" max="20" 
                                   onchange="updateDiceGroup(${group.id}, 'count', this.value)">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-shapes"></i> éª°å­é¢æ•°</label>
                            <select onchange="handleSidesChange(${group.id}, this.value)">
                                <option value="2" ${!group.isCustomSides && group.sides == 2 ? 'selected' : ''}>D2</option>
                                <option value="4" ${!group.isCustomSides && group.sides == 4 ? 'selected' : ''}>D4</option>
                                <option value="6" ${!group.isCustomSides && group.sides == 6 ? 'selected' : ''}>D6</option>
                                <option value="8" ${!group.isCustomSides && group.sides == 8 ? 'selected' : ''}>D8</option>
                                <option value="10" ${!group.isCustomSides && group.sides == 10 ? 'selected' : ''}>D10</option>
                                <option value="12" ${!group.isCustomSides && group.sides == 12 ? 'selected' : ''}>D12</option>
                                <option value="20" ${!group.isCustomSides && group.sides == 20 ? 'selected' : ''}>D20</option>
                                <option value="100" ${!group.isCustomSides && group.sides == 100 ? 'selected' : ''}>D100</option>
                                <option value="custom" ${group.isCustomSides ? 'selected' : ''}>è‡ªå®šä¹‰</option>
                            </select>
                            <input type="number" id="customSides-${group.id}" 
                                   value="${group.customSides}" min="1" max="1000000" 
                                   class="custom-sides-input" 
                                   onchange="updateDiceGroup(${group.id}, 'customSides', this.value)"
                                   ${group.isCustomSides ? 'style="display: block;"' : ''}>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-adjust"></i> è°ƒæ•´å€¼</label>
                            <div class="modifier-input">
                                <select onchange="updateDiceGroup(${group.id}, 'modifierType', this.value)">
                                    <option value="+" ${group.modifierType === '+' ? 'selected' : ''}>+</option>
                                    <option value="-" ${group.modifierType === '-' ? 'selected' : ''}>-</option>
                                </select>
                                <input type="number" value="${group.modifier}" min="-50" max="50"
                                       onchange="updateDiceGroup(${group.id}, 'modifier', this.value)">
                            </div>
                        </div>
                    </div>
                    <div class="group-controls">
                        <span style="color: rgba(255, 255, 255, 0.5); font-size: 0.85rem;">ç»„ ${index + 1}</span>
                        <button onclick="removeDiceGroup(${group.id})" class="remove-btn">
                            <i class="fas fa-trash"></i> ç§»é™¤
                        </button>
                    </div>
                `;
                container.appendChild(groupElement);
            });
        }
        
        // å¤„ç†é¢æ•°é€‰æ‹©å˜åŒ–
        function handleSidesChange(groupId, value) {
            const group = diceGroups.find(g => g.id === groupId);
            if (group) {
                if (value === 'custom') {
                    group.isCustomSides = true;
                    group.sides = group.customSides;
                    const customInput = document.getElementById(`customSides-${groupId}`);
                    if (customInput) {
                        customInput.style.display = 'block';
                        setTimeout(() => customInput.focus(), 300);
                    }
                } else {
                    group.isCustomSides = false;
                    group.sides = parseInt(value);
                    group.customSides = parseInt(value);
                    const customInput = document.getElementById(`customSides-${groupId}`);
                    if (customInput) {
                        customInput.style.display = 'none';
                    }
                }
                updateExpectation();
            }
        }
        
        // æ·»åŠ å…¨å±€è°ƒæ•´å€¼
        function addGlobalModifier() {
            globalModifiers.push({
                id: Date.now(),
                name: `è°ƒæ•´å€¼ ${globalModifiers.length + 1}`,
                value: 0,
                type: '+'
            });
            renderGlobalModifiers();
            updateExpectation();
        }
        
        // ç§»é™¤å…¨å±€è°ƒæ•´å€¼
        function removeGlobalModifier(id) {
            globalModifiers = globalModifiers.filter(mod => mod.id !== id);
            renderGlobalModifiers();
            updateExpectation();
        }
        
        // æ¸²æŸ“å…¨å±€è°ƒæ•´å€¼
        function renderGlobalModifiers() {
            const container = document.getElementById('globalModifiers');
            container.innerHTML = '';
            
            if (globalModifiers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-plus-circle"></i>
                        <p>æš‚æ— å…¨å±€è°ƒæ•´å€¼</p>
                    </div>
                `;
                return;
            }
            
            globalModifiers.forEach((modifier, index) => {
                const modifierElement = document.createElement('div');
                modifierElement.className = 'global-modifier';
                modifierElement.innerHTML = `
                    <input type="text" value="${modifier.name}" placeholder="è°ƒæ•´å€¼åç§°" 
                           onchange="updateGlobalModifier(${modifier.id}, 'name', this.value)">
                    <select onchange="updateGlobalModifier(${modifier.id}, 'type', this.value)">
                        <option value="+" ${modifier.type === '+' ? 'selected' : ''}>åŠ </option>
                        <option value="-" ${modifier.type === '-' ? 'selected' : ''}>å‡</option>
                    </select>
                    <input type="number" value="${modifier.value}" min="-100" max="100"
                           onchange="updateGlobalModifier(${modifier.id}, 'value', this.value)">
                    <button onclick="removeGlobalModifier(${modifier.id})" class="remove-btn" style="width: 100%;">
                        <i class="fas fa-trash"></i> åˆ é™¤
                    </button>
                `;
                container.appendChild(modifierElement);
            });
        }
        
        // æ›´æ–°éª°å­ç»„
        function updateDiceGroup(id, field, value) {
            const group = diceGroups.find(g => g.id === id);
            if (group) {
                if (field === 'count' || field === 'sides' || field === 'modifier' || field === 'customSides') {
                    const intValue = parseInt(value) || 0;
                    group[field] = intValue;
                    
                    if (field === 'customSides' && group.isCustomSides) {
                        group.sides = intValue;
                    }
                } else {
                    group[field] = value;
                }
                updateExpectation();
            }
        }
        
        // æ›´æ–°å…¨å±€è°ƒæ•´å€¼
        function updateGlobalModifier(id, field, value) {
            const modifier = globalModifiers.find(m => m.id === id);
            if (modifier) {
                if (field === 'value') {
                    modifier[field] = parseInt(value) || 0;
                } else {
                    modifier[field] = value;
                }
                updateExpectation();
            }
        }
        
        // è®¡ç®—æœŸæœ›å€¼
        function calculateExpectation() {
            let expectation = 0;
            
            // è®¡ç®—æ¯ä¸ªéª°å­ç»„çš„æœŸæœ›å€¼
            diceGroups.forEach((group) => {
                const groupExpectation = group.count * (group.sides + 1) / 2;
                let adjustedExpectation = groupExpectation;
                
                if (group.modifierType === '+') {
                    adjustedExpectation += group.modifier;
                } else {
                    adjustedExpectation -= group.modifier;
                }
                
                const truncatedExpectation = Math.trunc(adjustedExpectation);
                expectation += truncatedExpectation;
            });
            
            // åº”ç”¨å…¨å±€è°ƒæ•´å€¼
            globalModifiers.forEach(modifier => {
                if (modifier.type === '+') {
                    expectation += modifier.value;
                } else {
                    expectation -= modifier.value;
                }
            });
            
            return expectation;
        }
        
        // æ›´æ–°æœŸæœ›å€¼æ˜¾ç¤º
        function updateExpectation() {
            const expectation = calculateExpectation();
            document.getElementById('expectationDisplay').innerHTML = `
                <div class="expectation-value">${expectation}</div>
                <div class="expectation-label">æœŸæœ›å€¼</div>
            `;
        }
        
        // æŠ•æ·å•ä¸ªéª°å­
        function rollSingleDice(sides) {
            return Math.floor(Math.random() * sides) + 1;
        }
        
        // æŠ•æ·æ‰€æœ‰éª°å­
        function rollDice() {
            // æ·»åŠ æŠ•æ·åŠ¨ç”»
            const resultDisplay = document.getElementById('resultDisplay');
            const originalTotal = resultDisplay.querySelector('.result-total').textContent;
            const originalExpression = resultDisplay.querySelector('.result-expression').textContent;
            
            resultDisplay.innerHTML = `
                <div class="result-total" style="animation: diceRoll 0.5s ease-in-out infinite;">ğŸ²</div>
                <div class="result-expression">æŠ•æ·ä¸­...</div>
            `;
            
            // æ·»åŠ åŠ¨ç”»æ ·å¼
            const style = document.createElement('style');
            style.textContent = `
                @keyframes diceRoll {
                    0% { transform: rotate(0deg); }
                    25% { transform: rotate(90deg); }
                    50% { transform: rotate(180deg); }
                    75% { transform: rotate(270deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            setTimeout(() => {
                document.head.removeChild(style);
                
                let total = 0;
                let details = [];
                let rollExpression = '';
                
                // æŠ•æ·æ¯ä¸ªéª°å­ç»„
                diceGroups.forEach((group, index) => {
                    let groupTotal = 0;
                    let groupRolls = [];
                    
                    // æŠ•æ·è¯¥ç»„çš„æ‰€æœ‰éª°å­
                    for (let i = 0; i < group.count; i++) {
                        const roll = rollSingleDice(group.sides);
                        groupRolls.push(roll);
                        groupTotal += roll;
                    }
                    
                    // åº”ç”¨ç»„è°ƒæ•´å€¼
                    if (group.modifierType === '+') {
                        groupTotal += group.modifier;
                    } else {
                        groupTotal -= group.modifier;
                    }
                    
                    total += groupTotal;
                    
                    // æ„å»ºè¡¨è¾¾å¼
                    let groupExpression = '';
                    if (group.count > 1) {
                        groupExpression += `(${groupRolls.join('+')})`;
                    } else {
                        groupExpression += groupRolls[0];
                    }
                    
                    if (group.modifier !== 0) {
                        groupExpression += `${group.modifierType}${group.modifier}`;
                    }
                    
                    rollExpression += group.name + ': ' + groupExpression;
                    if (index < diceGroups.length - 1) {
                        rollExpression += ' + ';
                    }
                    
                    details.push({
                        name: group.name,
                        count: group.count,
                        sides: group.sides,
                        rolls: groupRolls,
                        modifier: group.modifier,
                        modifierType: group.modifierType,
                        groupTotal: groupTotal
                    });
                });
                
                // åº”ç”¨å…¨å±€è°ƒæ•´å€¼
                let globalExpression = '';
                globalModifiers.forEach((modifier, index) => {
                    if (modifier.type === '+') {
                        total += modifier.value;
                        globalExpression += ` + ${modifier.name}: ${modifier.value}`;
                    } else {
                        total -= modifier.value;
                        globalExpression += ` - ${modifier.name}: ${modifier.value}`;
                    }
                });
                
                rollExpression += globalExpression;
                
                // å¦‚æœæ²¡æœ‰éª°å­ç»„ï¼Œåªæœ‰å…¨å±€è°ƒæ•´å€¼
                if (diceGroups.length === 0 && globalModifiers.length > 0) {
                    rollExpression = 'ä»…å…¨å±€è°ƒæ•´å€¼: ' + globalExpression.substring(3);
                } else if (diceGroups.length === 0 && globalModifiers.length === 0) {
                    rollExpression = 'æ— éª°å­æŠ•æ·';
                    total = 0;
                }
                
                // æ˜¾ç¤ºç»“æœ
                resultDisplay.innerHTML = `
                    <div class="result-total">${total}</div>
                    <div class="result-expression">${rollExpression}</div>
                `;
                
                // æ·»åŠ ç»“æœåŠ¨ç”»
                resultDisplay.style.animation = 'resultAppear 0.5s ease-out';
                setTimeout(() => {
                    resultDisplay.style.animation = '';
                }, 500);
                
                // ä¿å­˜åˆ°å†å²è®°å½•
                const historyItem = {
                    id: Date.now(),
                    timestamp: new Date().toLocaleString('zh-CN'),
                    total: total,
                    expression: rollExpression,
                    details: details,
                    globalModifiers: [...globalModifiers],
                    note: diceGroups.length > 0 ? 
                        `${diceGroups.map(g => g.name).join(' + ')} æŠ•æ·` : 
                        'ä»…å…¨å±€è°ƒæ•´å€¼æŠ•æ·'
                };
                
                rollHistory.unshift(historyItem);
                saveHistory();
                renderHistory();
                updateStats();
            }, 800);
        }
        
        // æ¸…ç©ºæ‰€æœ‰è®¾ç½®
        function clearAllDice() {
            if (diceGroups.length === 0 && globalModifiers.length === 0) {
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰éª°å­ç»„å’Œè°ƒæ•´å€¼å—ï¼Ÿ')) {
                diceGroups = [];
                globalModifiers = [];
                renderDiceGroups();
                renderGlobalModifiers();
                document.getElementById('resultDisplay').innerHTML = `
                    <div class="result-total">0</div>
                    <div class="result-expression">ç‚¹å‡»æŠ•æ·æŸ¥çœ‹ç»“æœ</div>
                `;
                updateExpectation();
            }
        }
        
        // æ¸²æŸ“å†å²è®°å½•
        function renderHistory() {
            const container = document.getElementById('historyList');
            container.innerHTML = '';
            
            if (rollHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <p>æš‚æ— æŠ•æ·è®°å½•</p>
                    </div>
                `;
                return;
            }
            
            rollHistory.forEach(item => {
                const historyElement = document.createElement('div');
                historyElement.className = 'history-item';
                historyElement.innerHTML = `
                    <div class="history-header">
                        <div class="history-title">${item.note}</div>
                        <div class="history-time">${item.timestamp}</div>
                    </div>
                    <div class="history-result">${item.total}</div>
                    <div class="history-expression">${item.expression}</div>
                    <div class="history-actions">
                        <input type="text" placeholder="æ·»åŠ å¤‡æ³¨..." onchange="updateNote(${item.id}, this.value)" 
                               value="${item.note}">
                        <button onclick="reroll(${item.id})" class="reroll-btn">
                            <i class="fas fa-redo"></i> é‡æ–°æŠ•æ·
                        </button>
                        <button onclick="deleteHistory(${item.id})" class="delete-btn">
                            <i class="fas fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                `;
                container.appendChild(historyElement);
            });
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            if (rollHistory.length === 0) {
                document.getElementById('totalRolls').textContent = '0';
                document.getElementById('averageResult').textContent = '0';
                document.getElementById('maxResult').textContent = '0';
                document.getElementById('minResult').textContent = '0';
                return;
            }
            
            const total = rollHistory.length;
            const sum = rollHistory.reduce((acc, item) => acc + item.total, 0);
            const max = Math.max(...rollHistory.map(item => item.total));
            const min = Math.min(...rollHistory.map(item => item.total));
            const average = Math.trunc(sum / total);
            
            document.getElementById('totalRolls').textContent = total;
            document.getElementById('averageResult').textContent = average;
            document.getElementById('maxResult').textContent = max;
            document.getElementById('minResult').textContent = min;
        }
        
        // æ›´æ–°å¤‡æ³¨
        function updateNote(id, note) {
            const item = rollHistory.find(h => h.id === id);
            if (item && note.trim()) {
                item.note = note.trim();
                saveHistory();
                renderHistory();
            }
        }
        
        // é‡æ–°æŠ•æ·
        function reroll(id) {
            const originalItem = rollHistory.find(h => h.id === id);
            if (originalItem) {
                // è¿™é‡Œå¯ä»¥å®ç°é‡æ–°æŠ•æ·é€»è¾‘ï¼Œæš‚æ—¶ç®€å•å¤åˆ¶
                const newItem = {
                    ...originalItem,
                    id: Date.now(),
                    timestamp: new Date().toLocaleString('zh-CN'),
                    note: originalItem.note + ' (é‡æ–°æŠ•æ·)'
                };
                rollHistory.unshift(newItem);
                saveHistory();
                renderHistory();
                updateStats();
            }
        }
        
        // åˆ é™¤å†å²è®°å½•
        function deleteHistory(id) {
            rollHistory = rollHistory.filter(h => h.id !== id);
            saveHistory();
            renderHistory();
            updateStats();
        }
        
        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (rollHistory.length === 0) return;
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                rollHistory = [];
                saveHistory();
                renderHistory();
                updateStats();
            }
        }
        
        // å¯¼å‡ºå†å²è®°å½•
        function exportHistory() {
            if (rollHistory.length === 0) {
                alert('æš‚æ— å†å²è®°å½•å¯å¯¼å‡º');
                return;
            }
            
            const dataStr = JSON.stringify(rollHistory, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `dice_history_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }
        
        // ä¿å­˜å†å²è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
        function saveHistory() {
            localStorage.setItem('diceRollHistory', JSON.stringify(rollHistory));
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å†å²è®°å½•
        function loadHistory() {
            const saved = localStorage.getItem('diceRollHistory');
            if (saved) {
                rollHistory = JSON.parse(saved);
                renderHistory();
                updateStats();
            }
        }
        
        // æ·»åŠ åŠ¨ç”»æ ·å¼
        const animationStyle = document.createElement('style');
        animationStyle.textContent = `
            @keyframes resultAppear {
                0% { opacity: 0; transform: scale(0.8); }
                100% { opacity: 1; transform: scale(1); }
            }
        `;
        document.head.appendChild(animationStyle);
    </script>
</body>
</html>