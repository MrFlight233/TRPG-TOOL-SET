<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LOOT 记录 - TRPG工具集</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background: #f0f2f5;
            min-height: 100vh;
            color: #1f2937;
            padding: 15px;
            padding-bottom: env(safe-area-inset-bottom, 15px);
        }

        @supports (padding: max(0px)) {
            body {
                padding-left: max(15px, env(safe-area-inset-left, 15px));
                padding-right: max(15px, env(safe-area-inset-right, 15px));
                padding-bottom: max(15px, env(safe-area-inset-bottom, 15px));
            }
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            background: #fff;
            border-radius: 8px;
            padding: clamp(16px, 4vw, 24px);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            border: 1px solid #e5e7eb;
        }

        .back-btn {
            display: inline-flex;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #6b7280;
            padding: 10px 18px;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
            margin-top: 10px;
            transition: background 0.2s, border-color 0.2s;
            align-items: center;
            gap: 8px;
        }

        .back-btn:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
            color: #111827;
        }

        header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #e5e7eb;
        }

        h1 {
            font-size: clamp(1.5rem, 5vw, 2rem);
            margin-bottom: 6px;
            color: #111827;
            font-weight: 600;
        }

        .subtitle {
            font-size: clamp(0.8rem, 2.5vw, 0.95rem);
            color: #94989f;
        }

        .quick-add {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-end;
            background: #f9fafb;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
        }

        .quick-add .field {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .quick-add .field label {
            font-size: 0.8rem;
            color: #94989f;
        }

        .quick-add input,
        .quick-add select {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: #fff;
            color: #1f2937;
            font-size: 0.9rem;
            min-width: 0;
        }

        .quick-add input::placeholder {
            color: #9ca3af;
        }

        .quick-add .name {
            flex: 1;
            min-width: 120px;
        }

        .quick-add .qty {
            width: 70px;
        }

        .quick-add .price {
            width: 90px;
        }

        .quick-add .type {
            width: 100px;
        }

        .btn-primary {
            background: #2563eb;
            color: #fff;
            padding: 10px 18px;
            font-size: 0.9rem;
            font-weight: 500;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .btn-primary:hover {
            background: #1d4ed8;
        }

        .btn-secondary {
            background: #fff;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s, border-color 0.2s;
        }

        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }

        .players-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .players-bar .label {
            font-size: 0.875rem;
            color: #374151;
        }

        .players-bar input {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: #fff;
            color: #1f2937;
            width: 100px;
            font-size: 0.875rem;
        }

        .players-bar .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .players-bar .tag {
            background: #eff6ff;
            color: #2563eb;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            border: 1px solid #dbeafe;
        }

        .players-bar .tag .remove {
            cursor: pointer;
            opacity: 0.8;
        }

        .players-bar .tag .remove:hover {
            opacity: 1;
            color: #1d4ed8;
        }

        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 12px;
        }

        .toolbar select,
        .toolbar input {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: #fff;
            color: #1f2937;
            font-size: 0.85rem;
        }

        .toolbar .filter-name {
            width: 140px;
        }

        .toolbar .filter-type {
            width: 100px;
        }

        .toolbar .filter-owner {
            width: 100px;
        }

        .toolbar .filter-sold {
            width: 90px;
        }

        .view-toggle {
            margin-left: auto;
        }

        .view-toggle button {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        .view-toggle button.active {
            background: #eff6ff;
            border-color: #2563eb;
            color: #2563eb;
        }

        .table-wrap {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-bottom: 16px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            background: #fff;
        }

        .data-table th,
        .data-table td {
            padding: 10px 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .data-table th {
            background: #f9fafb;
            color: #374151;
            font-weight: 600;
            white-space: nowrap;
        }

        .data-table tr:hover {
            background: #fafafa;
        }

        .data-table td input,
        .data-table td select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #d1d5db;
            background: #fff;
            color: #1f2937;
            font-size: 0.85rem;
            width: 100%;
            max-width: 120px;
        }

        .data-table td .inline-qty {
            max-width: 60px;
        }

        .data-table .actions {
            display: flex;
            gap: 6px;
        }

        .btn-icon {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            color: #94989f;
            transition: background 0.2s, color 0.2s;
        }

        .btn-icon:hover {
            background: #eff6ff;
            color: #2563eb;
        }

        .btn-icon.del:hover {
            background: #fef2f2;
            color: #dc2626;
        }

        .data-table .sold-yes {
            color: #059669;
        }

        .data-table .sold-no {
            color: #d97706;
        }

        .data-table .col-note {
            max-width: 160px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table .hidden-cols {
            display: none;
        }

        .data-table.show-full .hidden-cols {
            display: table-cell;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #9ca3af;
        }

        .empty-state i {
            font-size: 2.5rem;
            margin-bottom: 12px;
            display: block;
            color: #d1d5db;
        }

        .stats-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            padding: 14px;
            background: #f9fafb;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
        }

        .stats-row .stat {
            font-size: 0.9rem;
            color: #374151;
        }

        .stats-row .stat strong {
            color: #111827;
            margin-right: 6px;
        }

        .stats-row .stat span {
            color: #2563eb;
            font-weight: 500;
        }

        .split-area {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .split-area input {
            width: 50px;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: #fff;
            color: #1f2937;
            text-align: center;
        }

        .export-btns {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #fff;
            border-radius: 8px;
            padding: 24px;
            max-width: 480px;
            width: 100%;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-header h3 {
            font-size: 1.125rem;
            color: #111827;
            font-weight: 600;
        }

        .modal .close-btn {
            background: none;
            border: none;
            color: #94989f;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal .close-btn:hover {
            color: #111827;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            font-size: 0.85rem;
            margin-bottom: 4px;
            color: #374151;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid #d1d5db;
            background: #fff;
            color: #1f2937;
            font-size: 0.9rem;
        }

        .form-group textarea {
            min-height: 70px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .form-row {
            display: flex;
            gap: 12px;
        }

        .form-row .form-group {
            flex: 1;
        }

        @media (max-width: 600px) {
            .quick-add {
                flex-direction: column;
                align-items: stretch;
            }

            .quick-add .name,
            .quick-add .qty,
            .quick-add .price,
            .quick-add .type {
                width: 100%;
            }

            .data-table th,
            .data-table td {
                padding: 8px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-coins"></i> LOOT 记录</h1>
            <p class="subtitle">快速记录战利品，支持表格内编辑与分配统计 · 数据保存在本机</p>
            <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> 返回首页</a>
        </header>

        <!-- 快速添加 -->
        <section class="quick-add">
            <div class="field name">
                <label>名称</label>
                <input type="text" id="quickName" placeholder="物品名称">
            </div>
            <div class="field qty">
                <label>数量</label>
                <input type="number" id="quickQty" min="1" value="1">
            </div>
            <div class="field price">
                <label>单价 (gp)</label>
                <input type="number" id="quickPrice" min="0" step="0.01" placeholder="0">
            </div>
            <div class="field type">
                <label>类型</label>
                <select id="quickType">
                    <option value="战利品">战利品</option>
                    <option value="金币">金币</option>
                    <option value="武器">武器</option>
                    <option value="装备">装备</option>
                    <option value="奇物">奇物</option>
                    <option value="消耗品">消耗品</option>
                    <option value="其他">其他</option>
                </select>
            </div>
            <button type="button" class="btn-primary" id="quickAddBtn"><i class="fas fa-plus"></i> 快速添加</button>
            <button type="button" class="btn-secondary" id="detailAddBtn"><i class="fas fa-edit"></i> 详细添加</button>
        </section>

        <!-- 参与分配的人 -->
        <section class="players-bar">
            <span class="label">参与分配：</span>
            <input type="text" id="newPlayerName" placeholder="输入玩家/角色名回车添加">
            <div class="tags" id="playerTags"></div>
        </section>

        <!-- 筛选与视图 -->
        <div class="toolbar">
            <input type="text" class="filter-name" id="filterName" placeholder="按名称筛选">
            <select class="filter-type" id="filterType">
                <option value="">全部类型</option>
                <option value="金币">金币</option>
                <option value="武器">武器</option>
                <option value="装备">装备</option>
                <option value="奇物">奇物</option>
                <option value="消耗品">消耗品</option>
                <option value="战利品">战利品</option>
                <option value="其他">其他</option>
            </select>
            <select class="filter-owner" id="filterOwner">
                <option value="">全部归属</option>
            </select>
            <select class="filter-sold" id="filterSold">
                <option value="">全部状态</option>
                <option value="false">未出售</option>
                <option value="true">已出售</option>
            </select>
            <button type="button" class="btn-secondary" id="resetFilter"><i class="fas fa-redo"></i> 重置</button>
            <div class="view-toggle">
                <button type="button" class="btn-secondary" id="viewCompact">紧凑</button>
                <button type="button" class="btn-secondary" id="viewFull">完整</button>
            </div>
        </div>

        <!-- 表格 -->
        <div class="table-wrap">
            <table class="data-table" id="lootTable">
                <thead>
                    <tr>
                        <th>名称</th>
                        <th>数量</th>
                        <th>单价</th>
                        <th>总价</th>
                        <th>类型</th>
                        <th>归属</th>
                        <th>状态</th>
                        <th class="hidden-cols">获取日期</th>
                        <th class="hidden-cols">备注</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="lootBody"></tbody>
            </table>
        </div>
        <div class="empty-state" id="emptyState">
            <i class="fas fa-chest"></i>
            <p>暂无记录，在上方输入名称、数量、单价后点击「快速添加」</p>
        </div>

        <!-- 统计与导出 -->
        <div class="stats-row" id="statsRow">
            <div class="stat">总价值 <span id="totalValue">0</span> gp</div>
            <div class="stat">未出售 <span id="unsoldValue">0</span> gp</div>
            <div class="split-area">
                <span>金币均分人数：</span>
                <input type="number" id="splitN" min="2" value="2" placeholder="N">
                <button type="button" class="btn-secondary" id="splitGoldBtn"><i class="fas fa-divide"></i>
                    均分未分配金币</button>
            </div>
            <div class="export-btns">
                <button type="button" class="btn-secondary" id="exportCsv"><i class="fas fa-file-csv"></i> 导出
                    CSV</button>
                <button type="button" class="btn-secondary" id="copySummary"><i class="fas fa-copy"></i> 复制摘要</button>
            </div>
        </div>
    </div>

    <!-- 详细添加/编辑 模态框 -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detailModalTitle">详细添加</h3>
                <button type="button" class="close-btn" id="closeDetailModal">&times;</button>
            </div>
            <form id="detailForm">
                <input type="hidden" id="detailId">
                <div class="form-group">
                    <label>名称 *</label>
                    <input type="text" id="detailName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>数量 *</label>
                        <input type="number" id="detailQty" min="1" value="1" required>
                    </div>
                    <div class="form-group">
                        <label>单价 (gp) *</label>
                        <input type="number" id="detailPrice" min="0" step="0.01" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>类型</label>
                        <select id="detailType">
                            <option value="战利品">战利品</option>
                            <option value="金币">金币</option>
                            <option value="武器">武器</option>
                            <option value="装备">装备</option>
                            <option value="奇物">奇物</option>
                            <option value="消耗品">消耗品</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>归属</label>
                        <select id="detailOwner">
                            <option value="">未分配</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>是否出售</label>
                        <select id="detailSold">
                            <option value="false">否</option>
                            <option value="true">是</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>获取日期</label>
                        <input type="date" id="detailDate">
                    </div>
                </div>
                <div class="form-group">
                    <label>备注（来源等）</label>
                    <textarea id="detailNote" placeholder="例如：地精首领、宝箱A"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelDetail">取消</button>
                    <button type="submit" class="btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'trpg_loot_page';
        const PLAYERS_KEY = 'trpg_loot_players';

        let loots = [];
        let players = [];

        function loadData() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) loots = JSON.parse(raw);
                else loots = [];
            } catch (e) { loots = []; }
            try {
                const raw = localStorage.getItem(PLAYERS_KEY);
                if (raw) players = JSON.parse(raw);
                else players = [];
            } catch (e) { players = []; }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(loots));
            localStorage.setItem(PLAYERS_KEY, JSON.stringify(players));
        }

        function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

        function escapeAttr(s) {
            if (!s) return '';
            return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;');
        }

        function getFilteredLoots() {
            const name = document.getElementById('filterName').value.trim().toLowerCase();
            const type = document.getElementById('filterType').value;
            const owner = document.getElementById('filterOwner').value;
            const sold = document.getElementById('filterSold').value;
            return loots.filter(l => {
                if (name && !l.name.toLowerCase().includes(name)) return false;
                if (type && l.type !== type) return false;
                if (owner !== '' && (l.owner || '') !== owner) return false;
                if (sold !== '' && l.sold !== sold) return false;
                return true;
            });
        }

        function renderOwnerOptions(sel) {
            const opts = ['<option value="">未分配</option>'];
            players.forEach(p => opts.push(`<option value="${p}">${p}</option>`));
            sel.innerHTML = opts.join('');
        }

        function refreshFilterOwner() {
            const sel = document.getElementById('filterOwner');
            const first = sel.innerHTML.split('</option>')[0] + '</option>';
            const rest = players.map(p => `<option value="${p}">${p}</option>`).join('');
            sel.innerHTML = first + rest;
        }

        function renderTable() {
            const list = getFilteredLoots();
            const tbody = document.getElementById('lootBody');
            const empty = document.getElementById('emptyState');
            const table = document.getElementById('lootTable');
            const statsRow = document.getElementById('statsRow');

            if (list.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                table.style.display = 'none';
                statsRow.style.display = 'none';
                return;
            }
            empty.style.display = 'none';
            table.style.display = 'table';
            statsRow.style.display = 'flex';

            const showFull = document.getElementById('lootTable').classList.contains('show-full');
            tbody.innerHTML = list.map(l => {
                const total = (l.price * l.quantity).toFixed(2);
                const soldClass = l.sold === 'true' ? 'sold-yes' : 'sold-no';
                const ownerOpts = ['<option value="">未分配</option>', ...players.map(p => `<option value="${escapeAttr(p)}" ${(l.owner || '') === p ? 'selected' : ''}>${escapeHtml(p)}</option>`)].join('');
                const dateCell = l.acquiredDate ? new Date(l.acquiredDate).toLocaleDateString() : '-';
                const noteCell = l.note || '-';
                return `<tr data-id="${l.id}">
                    <td>${escapeHtml(l.name)}</td>
                    <td><input type="number" class="inline-qty" min="1" value="${l.quantity}" data-field="quantity"></td>
                    <td>${parseFloat(l.price).toFixed(2)} gp</td>
                    <td>${total} gp</td>
                    <td>${l.type}</td>
                    <td><select data-field="owner">${ownerOpts}</select></td>
                    <td><select data-field="sold" class="${soldClass}"><option value="false" ${l.sold === 'false' ? 'selected' : ''}>未出售</option><option value="true" ${l.sold === 'true' ? 'selected' : ''}>已出售</option></select></td>
                    <td class="hidden-cols">${dateCell}</td>
                    <td class="hidden-cols col-note" title="${escapeAttr(l.note || '')}">${escapeHtml(noteCell)}</td>
                    <td class="actions">
                        <button type="button" class="btn-icon edit-row" title="编辑"><i class="fas fa-edit"></i></button>
                        <button type="button" class="btn-icon del delete-row" title="删除"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`;
            }).join('');

            bindTableEvents();
            updateStats();
        }

        function escapeHtml(s) {
            if (!s) return '';
            const div = document.createElement('div');
            div.textContent = s;
            return div.innerHTML;
        }

        function bindTableEvents() {
            document.querySelectorAll('#lootBody tr').forEach(tr => {
                const id = tr.dataset.id;
                tr.querySelectorAll('input[data-field="quantity"]').forEach(inp => {
                    inp.addEventListener('change', () => updateLootField(id, 'quantity', parseInt(inp.value, 10) || 1));
                });
                tr.querySelectorAll('select[data-field="owner"]').forEach(sel => {
                    sel.addEventListener('change', () => updateLootField(id, 'owner', sel.value));
                });
                tr.querySelectorAll('select[data-field="sold"]').forEach(sel => {
                    sel.addEventListener('change', () => updateLootField(id, 'sold', sel.value));
                });
                tr.querySelector('.edit-row')?.addEventListener('click', () => openDetailModal(id));
                tr.querySelector('.delete-row')?.addEventListener('click', () => deleteLoot(id));
            });
        }

        function updateLootField(id, field, value) {
            const l = loots.find(x => x.id === id);
            if (!l) return;
            if (field === 'quantity') l.quantity = Math.max(1, value);
            else if (field === 'owner') l.owner = value || null;
            else if (field === 'sold') l.sold = value;
            saveData();
            renderTable();
        }

        function updateStats() {
            const list = getFilteredLoots();
            let total = 0, unsold = 0;
            list.forEach(l => {
                const v = l.price * l.quantity;
                total += v;
                if (l.sold !== 'true') unsold += v;
            });
            document.getElementById('totalValue').textContent = total.toFixed(2);
            document.getElementById('unsoldValue').textContent = unsold.toFixed(2);
        }

        function deleteLoot(id) {
            if (!confirm('确定删除这条记录？')) return;
            loots = loots.filter(l => l.id !== id);
            saveData();
            renderTable();
        }

        function openDetailModal(id = null) {
            const modal = document.getElementById('detailModal');
            const title = document.getElementById('detailModalTitle');
            const form = document.getElementById('detailForm');
            form.reset();
            document.getElementById('detailId').value = id || '';
            renderOwnerOptions(document.getElementById('detailOwner'));

            if (id) {
                const l = loots.find(x => x.id === id);
                if (!l) return;
                title.textContent = '编辑';
                document.getElementById('detailName').value = l.name;
                document.getElementById('detailQty').value = l.quantity;
                document.getElementById('detailPrice').value = l.price;
                document.getElementById('detailType').value = l.type || '战利品';
                document.getElementById('detailOwner').value = l.owner || '';
                document.getElementById('detailSold').value = l.sold || 'false';
                document.getElementById('detailDate').value = l.acquiredDate ? l.acquiredDate.slice(0, 10) : '';
                document.getElementById('detailNote').value = l.note || '';
            } else {
                title.textContent = '详细添加';
                document.getElementById('detailDate').value = new Date().toISOString().slice(0, 10);
            }
            modal.classList.add('active');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        document.getElementById('detailForm').addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('detailId').value;
            const payload = {
                name: document.getElementById('detailName').value.trim(),
                quantity: parseInt(document.getElementById('detailQty').value, 10) || 1,
                price: parseFloat(document.getElementById('detailPrice').value) || 0,
                type: document.getElementById('detailType').value,
                owner: document.getElementById('detailOwner').value || null,
                sold: document.getElementById('detailSold').value,
                acquiredDate: document.getElementById('detailDate').value || null,
                note: document.getElementById('detailNote').value.trim() || null
            };
            if (id) {
                const l = loots.find(x => x.id === id);
                if (l) {
                    l.name = payload.name;
                    l.quantity = payload.quantity;
                    l.price = payload.price;
                    l.type = payload.type;
                    l.owner = payload.owner;
                    l.sold = payload.sold;
                    l.acquiredDate = payload.acquiredDate;
                    l.note = payload.note;
                }
            } else {
                loots.push({
                    id: uid(),
                    ...payload,
                    createDate: new Date().toISOString()
                });
            }
            saveData();
            renderTable();
            closeDetailModal();
        });

        document.getElementById('quickAddBtn').addEventListener('click', () => {
            const name = document.getElementById('quickName').value.trim();
            const qty = parseInt(document.getElementById('quickQty').value, 10) || 1;
            const price = parseFloat(document.getElementById('quickPrice').value) || 0;
            const type = document.getElementById('quickType').value;
            if (!name) { alert('请输入名称'); return; }
            loots.push({
                id: uid(),
                name,
                quantity: Math.max(1, qty),
                price,
                type,
                owner: null,
                sold: 'false',
                acquiredDate: new Date().toISOString().slice(0, 10),
                note: null,
                createDate: new Date().toISOString()
            });
            document.getElementById('quickName').value = '';
            document.getElementById('quickQty').value = '1';
            document.getElementById('quickPrice').value = '';
            saveData();
            renderTable();
        });

        document.getElementById('newPlayerName').addEventListener('keydown', e => {
            if (e.key !== 'Enter') return;
            e.preventDefault();
            const name = document.getElementById('newPlayerName').value.trim();
            if (!name || players.includes(name)) return;
            players.push(name);
            document.getElementById('newPlayerName').value = '';
            saveData();
            renderPlayerTags();
            refreshFilterOwner();
            renderOwnerOptions(document.getElementById('detailOwner'));
            renderTable();
        });

        function renderPlayerTags() {
            const el = document.getElementById('playerTags');
            el.innerHTML = players.map((p, i) => `<span class="tag">${escapeHtml(p)} <i class="fas fa-times remove" data-index="${i}"></i></span>`).join('');
            el.querySelectorAll('.remove').forEach(node => {
                node.addEventListener('click', () => {
                    const idx = parseInt(node.dataset.index, 10);
                    if (idx >= 0 && idx < players.length) {
                        players.splice(idx, 1);
                        saveData();
                        renderPlayerTags();
                        refreshFilterOwner();
                        renderTable();
                    }
                });
            });
        }

        document.getElementById('splitGoldBtn').addEventListener('click', () => {
            const n = parseInt(document.getElementById('splitN').value, 10);
            if (n < 2) { alert('人数至少为 2'); return; }
            const goldItems = loots.filter(l => l.type === '金币' && l.sold !== 'true' && !l.owner);
            if (goldItems.length === 0) { alert('没有未分配的金币类物品'); return; }
            let totalGold = 0;
            goldItems.forEach(l => { totalGold += l.price * l.quantity; });
            const per = totalGold / n;
            if (per < 0.01) { alert('总金币过少，无法均分'); return; }
            const names = players.slice(0, n);
            if (names.length < n) {
                for (let i = names.length; i < n; i++) names.push(`玩家${i + 1}`);
            }
            goldItems.forEach(l => {
                l.sold = 'true';
                l.owner = null;
            });
            names.forEach((name, i) => {
                loots.push({
                    id: uid(),
                    name: '金币（均分）',
                    quantity: 1,
                    price: Math.round(per * 100) / 100,
                    type: '金币',
                    owner: name,
                    sold: 'false',
                    acquiredDate: new Date().toISOString().slice(0, 10),
                    note: `均分自 ${totalGold.toFixed(2)} gp，${n} 人`,
                    createDate: new Date().toISOString()
                });
            });
            saveData();
            renderTable();
        });

        function exportCsv() {
            const list = getFilteredLoots();
            const headers = ['名称', '数量', '单价(gp)', '总价(gp)', '类型', '归属', '是否出售', '获取日期', '备注'];
            const rows = list.map(l => {
                const total = (l.price * l.quantity).toFixed(2);
                return [l.name, l.quantity, l.price, total, l.type, l.owner || '未分配', l.sold === 'true' ? '是' : '否', l.acquiredDate || '', l.note || ''];
            });
            const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(','))].join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `loot_${new Date().toISOString().slice(0, 10)}.csv`;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        function copySummary() {
            const list = getFilteredLoots();
            let total = 0, unsold = 0;
            const byOwner = {};
            list.forEach(l => {
                const v = l.price * l.quantity;
                total += v;
                if (l.sold !== 'true') {
                    unsold += v;
                    const o = l.owner || '未分配';
                    byOwner[o] = (byOwner[o] || 0) + v;
                }
            });
            let text = `LOOT 摘要\n总价值: ${total.toFixed(2)} gp  未出售: ${unsold.toFixed(2)} gp\n`;
            Object.entries(byOwner).sort((a, b) => b[1] - a[1]).forEach(([owner, val]) => {
                text += `${owner}: ${val.toFixed(2)} gp\n`;
            });
            navigator.clipboard.writeText(text).then(() => alert('已复制到剪贴板')).catch(() => alert('复制失败'));
        }

        document.getElementById('resetFilter').addEventListener('click', () => {
            document.getElementById('filterName').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('filterOwner').value = '';
            document.getElementById('filterSold').value = '';
            renderTable();
        });
        document.getElementById('filterName').addEventListener('input', renderTable);
        document.getElementById('filterType').addEventListener('change', renderTable);
        document.getElementById('filterOwner').addEventListener('change', renderTable);
        document.getElementById('filterSold').addEventListener('change', renderTable);

        document.getElementById('viewCompact').addEventListener('click', () => {
            document.getElementById('lootTable').classList.remove('show-full');
            document.getElementById('viewCompact').classList.add('active');
            document.getElementById('viewFull').classList.remove('active');
            renderTable();
        });
        document.getElementById('viewFull').addEventListener('click', () => {
            document.getElementById('lootTable').classList.add('show-full');
            document.getElementById('viewFull').classList.add('active');
            document.getElementById('viewCompact').classList.remove('active');
            renderTable();
        });

        document.getElementById('detailAddBtn').addEventListener('click', () => openDetailModal());
        document.getElementById('closeDetailModal').addEventListener('click', closeDetailModal);
        document.getElementById('cancelDetail').addEventListener('click', closeDetailModal);
        document.getElementById('exportCsv').addEventListener('click', exportCsv);
        document.getElementById('copySummary').addEventListener('click', copySummary);

        loadData();
        renderPlayerTags();
        refreshFilterOwner();
        renderTable();
        document.getElementById('viewCompact').classList.add('active');
    </script>
</body>

</html>